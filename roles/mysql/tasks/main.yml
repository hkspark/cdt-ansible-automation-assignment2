---
# =============================================================================
# MySQL Database Server Setup (COMPLETED - Session 1)
# =============================================================================
# This role installs and configures MySQL for WordPress.
#
# This role is already complete from Session 1. You can use it as a
# REFERENCE when building the WordPress and Nginx roles below.
#
# WHAT THIS ROLE DOES:
# - Installs MySQL server and the Python library Ansible needs
# - Starts the MySQL service and enables it on boot
# - Sets the root password (idempotently — safe to re-run!)
# - Creates a WordPress database and a dedicated user
# - Opens MySQL to network connections so WordPress can reach it
#
# NOTICE THE PATTERNS:
# - apt module      → installs packages
# - service module  → starts/enables services
# - Variables like "{{ mysql_root_password }}" come from group_vars/all.yml
# - Handlers (notify: Restart MySQL) only run when something changes
# =============================================================================

# Install the MySQL server package. The apt module handles package management
# on Debian/Ubuntu. 'update_cache' refreshes the package index first.
name: Install MySQL server
 ansible.builtin.apt:
 name: mysql-server
 state: present
 update_cache: true

# Ansible uses the PyMySQL library to talk to MySQL. Without this, the
# community.mysql modules (mysql_user, mysql_db) cannot connect.
name: Install Python MySQL library (required for Ansible)
 ansible.builtin.apt:
 name: python3-pymysql
 state: present

# The service module ensures MySQL is running now (state: started) and will
# start automatically on boot (enabled: true).
name: Start and enable MySQL service
 ansible.builtin.service:
 name: mysql
 state: started
 enabled: true

# Set the root password idempotently:
# - check_implicit_admin: true — on a fresh install, MySQL root has no
#   password, so the module first tries logging in without one. On later
#   runs it falls back to the login_password credentials below.
# - login_user / login_password — credentials for subsequent runs when
#   the password is already set.
name: Set MySQL root password
 community.mysql.mysql_user:
 name: root
 password: "{{ mysql_root_password }}"
 login_user: root
 login_password: "{{ mysql_root_password }}"
 login_unix_socket: /var/run/mysqld/mysqld.sock
 check_implicit_admin: true
 state: present

# Create the WordPress database. The mysql_db module is idempotent — if
# the database already exists, Ansible reports "ok" and moves on.
name: Create WordPress database
 community.mysql.mysql_db:
 name: "{{ wordpress_db_name }}"
 state: present
 login_user: root
 login_password: "{{ mysql_root_password }}"
 login_unix_socket: /var/run/mysqld/mysqld.sock

# Create a dedicated MySQL user for WordPress with privileges limited to
# the WordPress database only. The 'host' parameter controls which server
# IP is allowed to connect — here it's the WordPress application server.
name: Create WordPress database user
 community.mysql.mysql_user:
 name: "{{ wordpress_db_user }}"
 password: "{{ wordpress_db_password }}"
 priv: "{{ wordpress_db_name }}.*:ALL"
 host: "{{ wordpress_server }}"
 state: present
 login_user: root
 login_password: "{{ mysql_root_password }}"
 login_unix_socket: /var/run/mysqld/mysqld.sock

# By default MySQL only listens on 127.0.0.1. We change bind-address to
# 0.0.0.0 so the WordPress server can connect over the network.
# The 'notify' triggers the Restart MySQL handler only when this line
# actually changes — another example of idempotency.
name: Configure MySQL to accept remote connections
 ansible.builtin.lineinfile:
 path: /etc/mysql/mysql.conf.d/mysqld.cnf
 regexp: '^bind-address'
 line: 'bind-address = 0.0.0.0'
 notify: Restart MySQL